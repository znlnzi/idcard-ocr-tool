name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'  # ä½¿ç”¨å…¼å®¹æ€§æ›´å¥½çš„Pythonç‰ˆæœ¬
        
    - name: Install Tesseract OCR
      run: |
        # ä½¿ç”¨chocolateyå®‰è£…Tesseract OCR
        Write-Host "Installing Tesseract OCR via chocolatey..."
        choco install tesseract --yes --force
        
        # åˆ·æ–°ç¯å¢ƒå˜é‡
        refreshenv
        
        # æ‰¾åˆ°Tesseractå®‰è£…è·¯å¾„
        $tessPath = ""
        $possiblePaths = @(
          "C:\ProgramData\chocolatey\lib\tesseract\tools",
          "C:\Program Files\Tesseract-OCR",
          "C:\Program Files (x86)\Tesseract-OCR"
        )
        
        foreach ($path in $possiblePaths) {
          if (Test-Path "$path\tesseract.exe") {
            $tessPath = $path
            Write-Host "Found Tesseract at: $tessPath"
            break
          }
        }
        
        if ($tessPath -eq "") {
          Write-Host "Tesseract not found in expected locations, searching..."
          $tessExe = Get-ChildItem -Path "C:\" -Name "tesseract.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($tessExe) {
            $tessPath = Split-Path $tessExe.FullName
            Write-Host "Found Tesseract at: $tessPath"
          }
        }
        
        if ($tessPath -ne "") {
          # æ·»åŠ åˆ°PATH
          echo "$tessPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          $env:PATH += ";$tessPath"
          
          # è®¾ç½®tessdataç›®å½•
          $tessDataDir = "$tessPath\tessdata"
          if (!(Test-Path $tessDataDir)) {
            New-Item -ItemType Directory -Path $tessDataDir -Force
          }
          
          # ä¸‹è½½ä¸­æ–‡è¯­è¨€åŒ…
          Write-Host "Downloading Chinese language pack..."
          try {
            Invoke-WebRequest -Uri "https://github.com/tesseract-ocr/tessdata/raw/main/chi_sim.traineddata" -OutFile "$tessDataDir\chi_sim.traineddata"
            Write-Host "Chinese language pack downloaded successfully"
          } catch {
            Write-Host "Failed to download Chinese language pack: $($_.Exception.Message)"
          }
          
          # éªŒè¯Tesseractå®‰è£…
          Write-Host "Verifying Tesseract installation..."
          & "$tessPath\tesseract.exe" --version
          
          # åˆ—å‡ºå¯ç”¨è¯­è¨€
          Write-Host "Available languages:"
          & "$tessPath\tesseract.exe" --list-langs
          
        } else {
          Write-Host "ERROR: Could not find Tesseract installation"
          exit 1
        }
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build executable
      run: |
        python build.py
        
    - name: Verify build results
      run: |
        Write-Host "Checking build results..."
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†EXEæ–‡ä»¶
        if (Test-Path "dist\èº«ä»½è¯ä¿¡æ¯æå–å·¥å…·.exe") {
          $exeSize = (Get-Item "dist\èº«ä»½è¯ä¿¡æ¯æå–å·¥å…·.exe").Length
          Write-Host "âœ… EXE file generated successfully: $($exeSize / 1MB) MB"
          
          # æ£€æŸ¥æ–‡ä»¶å±æ€§
          $fileInfo = Get-Item "dist\èº«ä»½è¯ä¿¡æ¯æå–å·¥å…·.exe"
          Write-Host "File details:"
          Write-Host "  - Size: $($fileInfo.Length) bytes"
          Write-Host "  - Created: $($fileInfo.CreationTime)"
          Write-Host "  - Modified: $($fileInfo.LastWriteTime)"
          
        } else {
          Write-Host "âŒ EXE file not found!"
          exit 1
        }
        
        # æ£€æŸ¥æ˜¯å¦æœ‰releaseç›®å½•
        if (Test-Path "release") {
          $releaseFiles = Get-ChildItem "release" -Recurse
          Write-Host "âœ… Release package contains $($releaseFiles.Count) files"
        } else {
          Write-Host "âš ï¸ Release directory not found"
        }
        
        # åˆ—å‡ºdistç›®å½•å†…å®¹
        Write-Host "ğŸ“ dist/ directory contents:"
        Get-ChildItem "dist" | ForEach-Object {
          Write-Host "  - $($_.Name) ($($_.Length) bytes)"
        }
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: |
          dist/*.exe
          release/
        retention-days: 30
        
    - name: Create Release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.exe
          release/*.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}