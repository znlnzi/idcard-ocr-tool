# OCR识别调试指南

## 问题解决方案

你遇到的"OCR识别成功但姓名和民族为空"问题已经通过以下修复解决：

### 1. 主要修复内容

#### ✅ OCR配置优化
- **问题**: 原始配置使用了过度限制的字符白名单，可能排除了有效字符
- **修复**: 移除字符白名单限制，让Tesseract自由识别中文
- **配置变更**: `TESSERACT_CONFIG = '--oem 3 --psm 6'`

#### ✅ 区域定位优化  
- **问题**: 固定的区域坐标可能不适配所有身份证格式
- **修复**: 调整了姓名和民族区域的位置和大小
- **具体变更**:
  ```
  姓名区域: y从0.15调整到0.12, width从0.25增加到0.28
  民族区域: y从0.35调整到0.28, width从0.15增加到0.20
  ```

#### ✅ 多配置支持
- **新增**: 4种不同的OCR参数配置
  - `default`: 标准配置
  - `single_line`: 单行文字识别
  - `single_word`: 单个字符识别  
  - `sparse`: 稀疏文字识别

#### ✅ 备用区域配置
- **新增**: 2套备用区域定位方案
- **功能**: 如果默认区域识别失败，自动尝试其他区域配置

#### ✅ 文本清理改进
- **问题**: 过度的文本清理可能删除有效内容
- **修复**: 更保守的清理逻辑
- **改进**: 当清理后为空时，从原始文本中重新提取有效内容

#### ✅ 调试功能增强
- **新增**: 详细的调试日志输出
- **新增**: 中间图像保存功能
- **新增**: 多种OCR尝试的结果对比

### 2. 使用新功能

#### 启用调试模式
1. 启动程序
2. 勾选"启用调试模式（保存中间图像和详细日志）"复选框
3. 选择图片文件夹和输出文件
4. 开始处理

#### 查看调试信息
启用调试模式后，你会看到：
```
[DEBUG] 开始识别图像: /path/to/image.jpg
[DEBUG] 预处理完成，图像尺寸: (640, 400, 3)
[DEBUG] 提取到 2 个文字区域
[DEBUG] 姓名区域OCR原始结果: '姓名张三'
[DEBUG] 姓名清理前: '姓名张三'
[DEBUG] 去除空白后: '姓名张三'
[DEBUG] 保留中英文后: '姓名张三'  
[DEBUG] 移除标签后: '张三'
[DEBUG] 姓名最终结果: '张三'
[DEBUG] 民族OCR原始结果: '民族汉族'
[DEBUG] 民族清理结果: '汉族'
[DEBUG] 最终识别结果: 姓名='张三', 民族='汉族'
```

#### 查看中间图像
调试模式会在输入文件夹下创建`debug`目录，保存：
- `*_processed.jpg`: 预处理后的完整图像
- `*_name_region.jpg`: 姓名区域提取图像
- `*_ethnicity_region.jpg`: 民族区域提取图像

### 3. 多方法识别
程序现在自动使用多种方法尝试识别：
1. 首先使用默认区域配置
2. 如果结果不佳，尝试备用区域配置1
3. 再不行则尝试备用区域配置2
4. 每个区域配置都会尝试多种OCR参数
5. 最终选择最佳识别结果

### 4. 常见问题排查

#### 如果仍然识别为空
1. 检查调试日志中的原始OCR文本
2. 查看debug文件夹中的区域图像是否正确截取
3. 如果区域定位不准确，可以手动调整配置文件中的坐标

#### 区域定位调整
编辑 `src/config/settings.py`：
```python
ID_CARD_REGIONS = {
    'name': {
        'x': 0.13,      # 左边距（0-1之间的比例）
        'y': 0.12,      # 上边距  
        'width': 0.28,  # 宽度
        'height': 0.10  # 高度
    },
    'ethnicity': {
        'x': 0.13,      # 与姓名对齐
        'y': 0.28,      # 在姓名下方
        'width': 0.20,  
        'height': 0.10
    }
}
```

### 5. 重新构建程序

使用GitHub Actions自动构建：
```bash
git add .
git commit -m "修复OCR识别空结果问题"
git push
```

或者本地构建（如果有完整环境）：
```bash
python build.py
```

### 6. 验证修复效果

运行测试脚本验证：
```bash
python3 test_core.py
```

现在你的OCR识别问题应该得到解决。启用调试模式可以帮你详细了解识别过程，如果还有问题，可以根据调试日志进一步分析。